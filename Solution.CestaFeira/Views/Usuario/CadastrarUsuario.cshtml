@using CestaFeira.Web.Models.Usuario
@model UsuarioModel

@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Registrar Usuário</title>
    <link href="css/styles.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
</head>

<body style="background-color: #4CAF50;">
    <div class="container d-flex align-items-center justify-content-center min-vh-100">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0 rounded-lg">

                <div class="card-header text-center">
                    <h3 class="font-weight-light my-4">Criar uma Conta</h3>
                </div>

                <div class="card-body p-4">
                    <form method="post" asp-action="CadastrarUsuario" novalidate>

                        @if (TempData["ErrorMessage"] != null)
                        {
                            <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
                        }

                        <!-- Nome e CPF -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input class="form-control" asp-for="Nome" placeholder="Nome completo" required />
                                    <label asp-for="Nome">Nome Completo</label>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating position-relative">
                                    <input class="form-control" asp-for="cpf" id="cpf" placeholder="CPF" required />
                                    <label asp-for="cpf">CPF</label>

                                    <!-- Mensagem CPF inválido -->
                                    <small id="cpfInvalidoMsg" class="text-danger" style="display:none;">
                                        CPF inválido.
                                    </small>

                                    <!-- Aviso PIX para produtor -->
                                    <small id="cpfPixMsg" class="text-warning fw-bold" style="display:none;">
                                        ⚠ Atenção: este CPF deve estar vinculado a uma chave PIX válida.
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Email e celular -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input class="form-control" asp-for="Email" type="email" placeholder="Email" required />
                                    <label asp-for="Email">E-mail</label>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input class="form-control" asp-for="Cel" placeholder="Celular" required />
                                    <label asp-for="Cel">Celular</label>
                                </div>
                            </div>
                        </div>

                        <!-- Senha e confirmação -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input class="form-control" asp-for="Senha" type="password" placeholder="Senha" id="senha" required />
                                    <label asp-for="Senha">Senha</label>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input class="form-control" id="confirmSenha" type="password" placeholder="Confirmar Senha" required />
                                    <label for="confirmSenha">Confirmar Senha</label>
                                </div>
                            </div>
                        </div>

                        <!-- Endereço -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input class="form-control" asp-for="Rua" placeholder="Rua" required />
                                    <label asp-for="Rua">Rua</label>
                                </div>
                            </div>

                            <div class="col-md-2">
                                <div class="form-floating">
                                    <input class="form-control" asp-for="Numero" placeholder="Número" required />
                                    <label asp-for="Numero">Número</label>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="form-floating">
                                    <input class="form-control" asp-for="Bairro" placeholder="Bairro" required />
                                    <label asp-for="Bairro">Bairro</label>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="form-floating">
                                    <input class="form-control" asp-for="Cidade" placeholder="Cidade" required />
                                    <label asp-for="Cidade">Cidade</label>
                                </div>
                            </div>
                        </div>

                        <!-- UF e Data -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <select class="form-select" asp-for="Uf" required>
                                        <option value="">Selecione o Estado</option>
                                        <option value="MG">MG - Minas Gerais</option>
                                        <option value="SP">SP - São Paulo</option>
                                        <option value="RJ">RJ - Rio de Janeiro</option>
                                        <option value="BA">BA - Bahia</option>
                                        <option value="PR">PR - Paraná</option>
                                        <!-- (demais estados mantidos se quiser, cortei aqui só pra enxugar) -->
                                    </select>
                                    <label asp-for="Uf">Estado (UF)</label>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input class="form-control" asp-for="Data" type="date" required />
                                    <label asp-for="Data">Data de Nascimento</label>
                                </div>
                            </div>
                        </div>

                        <!-- Perfil -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <select class="form-select" asp-for="Perfil" id="perfilSelect" required onchange="toggleNomeFantasia()">
                                        <option value="COMUM">Consumidor</option>
                                        <option value="PROD">Produtor</option>
                                    </select>
                                    <label asp-for="Perfil">Perfil</label>
                                </div>
                            </div>
                        </div>

                        <!-- Nome Fantasia -->
                        <div class="row mb-3" id="nomeFantasiaDiv" style="display:none;">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input class="form-control" asp-for="NomeFantasia" placeholder="Nome Fantasia" />
                                    <label asp-for="NomeFantasia">Nome Fantasia</label>
                                </div>
                            </div>
                        </div>

                        <!-- Botão -->
                        <div class="mt-4 mb-0">
                            <div class="d-grid">
                                <button type="submit" class="btn btn-success btn-block" onclick="return validarFormulario()">Criar Conta</button>
                            </div>
                        </div>

                    </form>
                </div>

                <div class="card-footer text-center py-3">
                    <div class="small">
                        <a asp-controller="Usuario" asp-action="Login">Já tem uma conta? Faça login</a>
                    </div>
                </div>

            </div>
        </div>
    </div>


    <!-- SCRIPTS -->
    <script>
        // ===== Validação de CPF =====
        function validarCPF(cpf) {
            if (!cpf) return false;
            cpf = cpf.replace(/[^\d]+/g, "");
            if (cpf.length !== 11) return false;
            if (/^(\d)\1{10}$/.test(cpf)) return false;

            let soma = 0, resto;

            for (let i = 1; i <= 9; i++)
                soma += parseInt(cpf[i - 1]) * (11 - i);

            resto = (soma * 10) % 11;
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(cpf[9])) return false;

            soma = 0;
            for (let i = 1; i <= 10; i++)
                soma += parseInt(cpf[i - 1]) * (12 - i);

            resto = (soma * 10) % 11;
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(cpf[10])) return false;

            return true;
        }

        // Validação Senhas
        function validarSenhas() {
            const senha = document.getElementById("senha").value;
            const confirmSenha = document.getElementById("confirmSenha").value;
            if (senha !== confirmSenha) {
                alert("As senhas não correspondem.");
                return false;
            }
            return true;
        }

        // Validação geral
        function validarFormulario() {

            if (!validarSenhas()) return false;

            const cpfInput = document.getElementById("cpf");
            const cpfMsg = document.getElementById("cpfInvalidoMsg");
            const cpf = cpfInput.value;

            if (!validarCPF(cpf)) {
                cpfMsg.style.display = "block";
                alert("CPF inválido. Verifique e tente novamente.");
                cpfInput.focus();
                return false;
            } else {
                cpfMsg.style.display = "none";
            }

            return true;
        }

        // Mostrar/esconder Nome Fantasia + mensagem PIX
        function toggleNomeFantasia() {
            const perfil = document.getElementById("perfilSelect").value;
            const nomeFantasiaDiv = document.getElementById("nomeFantasiaDiv");
            const msgPix = document.getElementById("cpfPixMsg");

            if (perfil === "PROD") {
                nomeFantasiaDiv.style.display = "block";
                msgPix.style.display = "block";
            } else {
                nomeFantasiaDiv.style.display = "none";
                msgPix.style.display = "none";
            }
        }

        // Validação CPF em tempo real
        document.getElementById("cpf").addEventListener("input", function () {
            const msg = document.getElementById("cpfInvalidoMsg");
            if (this.value.length >= 11) {
                if (!validarCPF(this.value)) {
                    msg.style.display = "block";
                    this.classList.add("is-invalid");
                } else {
                    msg.style.display = "none";
                    this.classList.remove("is-invalid");
                }
            } else {
                msg.style.display = "none";
                this.classList.remove("is-invalid");
            }
        });

        document.addEventListener("DOMContentLoaded", toggleNomeFantasia);
    </script>

</body>
</html>
